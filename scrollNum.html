<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>摇一摇骰子</title>
</head>
<style>
    html,
    body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden
    }
    
    body {
        max-width: 640px;
        margin: 0 auto;
        background: url(bg.jpg)
    }
    
    a {
        text-decoration: none;
        font-size: 15px;
        color: #333;
    }
    
    .clear::after {
        display: block;
        content: "";
        clear: both
    }
    
    .fl {
        float: left
    }
    
    .fr {
        float: right
    }
    
    #mainWrp {
        position: relative;
        height: 100%;
        width: 100%;
    }
    
    .dice {
        position: absolute;
        display: block;
        z-index: 3;
        padding: 10%;
        box-sizing: border-box;
        background-repeat: no-repeat;
        background-size: 98% auto;
        background-position: center center;
        transition: top 420ms linear, left 420ms linear
    }
    
    .roller {
        animation: roller 320ms linear infinite
    }
    
    @keyframes roller {
        0% {
            transform: rotateZ(0)
        }
        100% {
            transform: rotateZ(360deg)
        }
    }
    
    .dice.on {
        border-radius: 3px;
        background-color: #FFEB66;
    }
    
    #num1 {
        background-image: url(dice1.png)
    }
    
    #num2 {
        background-image: url(dice2.png)
    }
    
    #num3 {
        background-image: url(dice3.png)
    }
    
    #num4 {
        background-image: url(dice4.png)
    }
    
    #num5 {
        background-image: url(dice5.png)
    }
    
    #num6 {
        background-image: url(dice6.png)
    }
    
    #mubu {
        position: fixed;
        z-index: 9;
        top: 0;
        left: 0;
        right: 0;
        transition: all 370ms ease-out;
        bottom: 100%;
        display: block;
        width: 100%;
        background-color: #421728;
        background-image: url('adBg.jpg');
        background-repeat: no-repeat;
        background-size: 100% auto;
        background-position: center center;
        overflow: hidden
    }
    
    #szBtn,
    #mbBtn {
        display: block;
        height: 45px;
        width: 45px;
        color: #fff;
        font-size: 13px;
        text-align: center;
        line-height: 37px;
        background-repeat: no-repeat;
        background-size: 100% auto;
        background-position: center center;
        position: absolute;
        bottom: 5px;
        right: 5px;
        text-decoration: none
    }
    
    #szBtn {
        background-image: url('szBtnBg.png');
    }
    
    #mbBtn {
        left: 5px;
        background-image: url('mbBg0.png');
    }
    
    .BtnWrp {
        position: fixed;
        box-sizing: border-box;
        padding: 0 50px;
        height: 51px;
        width: 100%;
        bottom: 50px;
        left: 0
    }
    
    #plsBtn,
    #musBtn {
        display: block;
        text-align: center;
        background-repeat: no-repeat;
        background-size: 100% auto;
        background-position: center center;
        box-sizing: border-box;
        height: 35px;
        width: 35px;
        line-height: 33px;
        margin: 5px;
    }
    
    #plsBtn {
        float: right;
        background-image: url('add1.png');
    }
    
    #musBtn {
        float: left;
        background-image: url('add.png');
    }
    
    .BtnWrp div.clear {
        background-image: url('btnWrpBg.png');
        background-repeat: no-repeat;
        background-size: 110px auto;
        width: 140px;
        background-position: 17px center;
        position: relative;
        top: 5px;
        text-align: center;
        margin: 0 auto;
    }
    
    #diceNumber {
        color: #fff;
        margin: 5px auto;
        padding: 0;
        width: 50px;
        background: none;
        border: none;
        font-weight: bold;
        font-size: 15px;
        box-sizing: border-box;
        line-height: 35px;
        text-align: center;
    }
</style>

<body>
    <audio hidden id="yao" src="007.mp3"></audio>
    <div id="mubu" data-tog="off"></div>

    <div id="mainWrp">
        <div id="num1" style="top:-20%;left:0" class="dice roller" select="0"></div>
        <div id="num2" style="top:-20%;left:0" class="dice roller" select="0"></div>
        <div id="num3" style="top:-20%;left:0" class="dice roller" select="0"></div>
        <div id="num4" style="top:-20%;left:0" class="dice roller" select="0"></div>
        <div id="num5" style="top:-20%;left:0" class="dice roller" select="0"></div>
        <div id="num6" style="top:-20%;left:0" class="dice roller" select="0"></div>
        <div id="num7" style="top:-20%;left:0" class="dice roller" select="0"></div>
        <div id="num8" style="top:-20%;left:0" class="dice roller" select="0"></div>
        <div id="num9" style="top:-20%;left:0" class="dice roller" select="0"></div>
        <div id="num10" style="top:-20%;left:0" class="dice roller" select="0"></div>

    </div>
    <div class="BtnWrp clear">
        <a id="mbBtn" href="javascript:;"></a>
        <div class="clear">
            <a id="musBtn" onclick="minusDice()" href="javascript:;"></a>
            <input id="diceNumber" type="number" value="5" disabled>
            <a id="plsBtn" onclick="addDice()" href="javascript:;"></a>
        </div>
        <a id="szBtn" href="javascript:;"></a>
    </div>
    <script>
        var arrNums = [{
            "number": num1,
            "lefPos": "0",
            "topPos": "-20%",
            "select": "0"
        }, {
            "number": num2,
            "lefPos": "0",
            "topPos": "-20%",
            "select": "0",
        }, {
            "number": num3,
            "lefPos": "0",
            "topPos": "-20%",
            "select": "0",
        }, {
            "number": num4,
            "lefPos": "0",
            "topPos": "-20%",
            "select": "0",
        }, {
            "number": num5,
            "lefPos": "0",
            "topPos": "-20%",
            "select": "0",
        }, {
            "number": num6,
            "lefPos": "0",
            "topPos": "-20%",
            "select": "0",
        }, {
            "number": num7,
            "lefPos": "0",
            "topPos": "-20%",
            "select": "0",
        }, {
            "number": num8,
            "lefPos": "0",
            "topPos": "-20%",
            "select": "0",
        }, {
            "number": num9,
            "lefPos": "0",
            "topPos": "-20%",
            "select": "0",
        }, {
            "number": num10,
            "lefPos": "0",
            "topPos": "-20%",
            "select": "0",
        }];
        var dices = document.getElementsByClassName("dice");
        var diceTopStep = diceWidth = dices[0].clientWidth;
        var mubu = document.getElementById("mubu");
        var mbBtn = document.getElementById("mbBtn");
        var szBtn = document.getElementById("szBtn");
        var diceNumber = document.getElementById("diceNumber");
        var yaudio = document.getElementById("yao");
        var diceNumbers = 5;
        document.addEventListener("WeixinJSBridgeReady", function() {
            yaudio.load();
        }, false);

        function addDice() {
            if (diceNumber.value < 10) {
                diceNumber.value = Number(diceNumber.value) + 1;
                diceNumbers = diceNumber.value;
                scrollNum(diceNumbers);
            }

        }

        function minusDice() {
            for (var i = 0; i < diceNumbers; i++) {
                if (arrNums[i].select == "1") {
                    return alert("请先解锁骰子，再减少数量！")
                }
            }
            if (diceNumber.value > 1) {
                diceNumber.value = diceNumber.value - 1;
                diceNumbers = diceNumber.value;
                scrollNum(diceNumbers);
            }

        }

        function togCover() {
            var isShow = mubu.getAttribute("data-tog");
            if (isShow == "off") {
                mbBtn.style.backgroundImage = "url('mbBg1.png')";
                mubu.setAttribute("data-tog", "on");
                mubu.style.bottom = "100px";
            } else {
                mbBtn.style.backgroundImage = "url('mbBg0.png')";
                mubu.setAttribute("data-tog", "off");
                mubu.style.bottom = "";
            }
        }




        function scrollNum(diceNumbers) {
            setTimeout(function() {
                for (var k = 0; k < 10; k++) {
                    if (arrNums[k].select == "0") {
                        dices[k].className = "dice roller";
                    }
                }
            }, 70);

            for (var m = 0; m < 10; m++) {
                if (arrNums[m].select == "0") {
                    dices[m].style.left = "-25%";
                    dices[m].style.top = "-20%";
                    arrNums[m]["lefPos"] = "-25%";
                    arrNums[m]["topPos"] = "-20%";
                }
            }

            setTimeout(function() {

                for (var i = 0; i < diceNumbers; i++) {

                    if (arrNums[i].select == "0") {

                        do {

                            var lefPos = Math.floor(Math.random() * 5) * 20 + "%";
                            var topPos = Math.floor(Math.random() * 5) * diceTopStep + "px";

                        } while (lefPos == arrNums[0].lefPos && topPos == arrNums[0].topPos || lefPos == arrNums[1].lefPos && topPos == arrNums[1].topPos || lefPos == arrNums[2].lefPos && topPos == arrNums[2].topPos || lefPos == arrNums[3].lefPos && topPos == arrNums[3].topPos || lefPos == arrNums[4].lefPos && topPos == arrNums[4].topPos || lefPos == arrNums[5].lefPos && topPos == arrNums[5].topPos || lefPos == arrNums[6].lefPos && topPos == arrNums[6].topPos || lefPos == arrNums[7].lefPos && topPos == arrNums[7].topPos || lefPos == arrNums[8].lefPos && topPos == arrNums[8].topPos || lefPos == arrNums[9].lefPos && topPos == arrNums[9].topPos)


                        dices[i].style.left = lefPos;
                        dices[i].style.top = topPos;
                        dices[i].style.backgroundImage = "url(dice" + Math.floor(Math.random() * 6 + 1) + ".png)";

                        arrNums[i]["number"] = dices[i].id;
                        arrNums[i]["topPos"] = topPos;
                        arrNums[i]["lefPos"] = lefPos;
                        arrNums[i]["select"] = "0";

                    }

                }

            }, 360);

            setTimeout(function() {
                for (var k = 0; k < 10; k++) {
                    if (arrNums[k].select == "0") {
                        dices[k].className = "dice";
                    }
                }
            }, 900);

        }
        scrollNum(diceNumbers)
            // 点击选中
        for (var i = 0; i < 10; i++) {
            dices[i].addEventListener("touchstart", function() {
                if (this.getAttribute("select") == 0) {
                    this.setAttribute("select", "1");
                    this.className = "dice on";
                    for (var l = 0; l < 10; l++) {
                        if (arrNums[l].number == this.id) {
                            arrNums[l].select = "1";
                        }
                    }

                } else {
                    this.setAttribute("select", "0");
                    this.className = "dice";
                    for (var l = 0; l < 10; l++) {
                        if (arrNums[l].number == this.id) {
                            arrNums[l].select = "0";
                        }
                    }

                }
            });

            dices[i].addEventListener("webkitTransitionEnd", function() {
                yaudio.pause();
            })


        }

        szBtn.addEventListener("touchstart", function() {

            yaudio.play();
            scrollNum(diceNumbers);
        });

        mbBtn.addEventListener("touchstart", togCover, false);
        var startY = endY = 0;
        mubu.addEventListener("touchstart", function(evt) {
            startY = evt.targetTouches[0].clientY
        });
        mubu.addEventListener("touchmove", function(evt) {
            endY = evt.targetTouches[0].clientY
        });
        mubu.addEventListener("touchend", function(evt) {
            if (startY - endY > 0) {
                mbBtn.style.backgroundImage = "url('mbBg0.png')";
                mubu.setAttribute("data-tog", "off");
                mubu.style.bottom = "";
            }
        });

        if (window.DeviceMotionEvent) {
            window.addEventListener('devicemotion', deviceMotionHandler, false);
        } else {
            alert("您的手机不支持摇一摇,请点'骰它'按钮来摇骰子！");
        }
        var speed = 22;
        var x = y = z = lastX = lastY = lastZ = 0;

        function deviceMotionHandler(eventData) {
            var acceleration = eventData.accelerationIncludingGravity;
            x = acceleration.x;
            y = acceleration.y;
            z = acceleration.z;
            if (Math.abs(x - lastX) > speed || Math.abs(y - lastY) > speed || Math.abs(z - lastZ) > speed) {
                yaudio.play();
                scrollNum(diceNumbers);
            }
            lastX = x;
            lastY = y;
            lastZ = z;
        }
    </script>
</body>

</html>